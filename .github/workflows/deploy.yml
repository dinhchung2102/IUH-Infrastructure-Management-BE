name: Deploy to Windows Server

on:
  push:
    branches:
      - main

env:
  NODE_VERSION: '22'

jobs:
  deploy:
    runs-on: self-hosted

    environment:
      name: production
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Stop running app (if any)
        run: |
          pm2 stop iuh-infrastructure-be
          if %ERRORLEVEL% neq 0 echo App not running
        shell: cmd

      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm install
        shell: cmd

      - name: Build project
        run: npm run build
        shell: cmd

      - name: Start/Restart app using PM2
        id: deploy
        run: |
          pm2 restart iuh-infrastructure-be || pm2 start dist/main.js --name iuh-infrastructure-be
        shell: cmd

      - name: Copy .env from external location
        run: copy C:\envs\iuh-infrastructure-be\.env .env
        shell: cmd
