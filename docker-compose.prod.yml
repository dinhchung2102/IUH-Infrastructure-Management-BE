services:
  # NestJS Application
  app:
    # Build từ Dockerfile local thay vì pull từ registry
    build:
      context: .
      dockerfile: Dockerfile
    # Optional: Tag image sau khi build (uncomment nếu muốn)
    # image: iuh-csvc:latest
    container_name: iuh-csvc-api
    # Dùng host network để dễ kết nối với services trên host (MongoDB, Redis, Qdrant)
    network_mode: host
    volumes:
      # Bind mount từ host để persist data (uploads và logs)
      # Thư mục /var/www/uploads/iuh và /var/log/iuh đã được tạo trong Dockerfile với chown node:node
      # Entrypoint script sẽ đảm bảo permissions đúng khi container start
      - ./uploads:/var/www/uploads/iuh:rw
      - ./logs:/var/log/iuh:rw
      # Mount timezone để đồng bộ thời gian với host
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    environment:
      - NODE_ENV=production
      - PORT=3000
      - TZ=Asia/Ho_Chi_Minh
      # Qdrant - dùng localhost vì network_mode: host
      - QDRANT_URL=${QDRANT_URL:-http://localhost:6333}
      # Redis - dùng localhost vì network_mode: host
      - REDIS_HOST=${REDIS_HOST:-localhost}
      - REDIS_PORT=${REDIS_PORT:-6379}
      # MongoDB - dùng localhost vì network_mode: host
      # Note: MONGO_URI sẽ được đọc từ .env, nên dùng mongodb://localhost:27017/...
    env_file:
      - .env
    healthcheck:
      test:
        [
          'CMD',
          'node',
          '-e',
          "require('http').get('http://localhost:3000/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    # Option 1: Chạy với user hiện tại (đảm bảo permissions trên host đã đúng)
    # Uncomment dòng dưới nếu muốn chạy với user cụ thể
    #user: '${UID:-1000}:${GID:-1000}'
    # Option 2: Để entrypoint script tự fix permissions (mặc định)
    # Entrypoint script sẽ chạy với root để fix permissions, sau đó switch sang node user
    init: true
# Redis và Qdrant chạy trên host, không cần trong Docker Compose
